<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Mural Interativo</title>
  <style>
    :root {
      --bg: #f3f6fa;
      --ink: #1e2a36;
      --muted: #6b7785;
      --card: #ffffff;
      --line: #d8e0e8;
      --brand: #0a66d1;
      --ok: #1a9b56;
      --warn: #d9534f;
      --app-height: 100vh;
    }

    * { box-sizing: border-box; }
    html, body {
      width: 100%;
      height: 100%;
      min-height: 100%;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #f7f9fc 0%, var(--bg) 40%);
      color: var(--ink);
      min-height: var(--app-height);
      min-height: -webkit-fill-available;
      -webkit-text-size-adjust: 100%;
      overflow-x: hidden;
      touch-action: manipulation;
    }

    .app {
      max-width: 720px;
      margin: 0 auto;
      padding: 14px 12px calc(24px + env(safe-area-inset-bottom));
    }

    .top {
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(243, 246, 250, 0.94);
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--line);
      margin: -14px -12px 12px;
      padding: 14px 12px 10px;
    }

    .title {
      margin: 0;
      font-size: 1.35rem;
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .subtitle {
      margin-top: 4px;
      color: var(--muted);
      font-size: 0.92rem;
    }

    .tabs {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
    }

    .tab-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--line);
      background: #fff;
      color: #344051;
      border-radius: 10px;
      padding: 8px 6px;
      min-height: 40px;
      font-weight: 700;
      font-size: 0.82rem;
      line-height: 1.15;
      text-align: center;
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .tab-btn.active {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }

    @media (max-width: 520px) {
      .tabs {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .status {
      margin: 10px 0 0;
      font-size: 0.84rem;
      color: var(--muted);
    }

    .vagas-grid {
      display: grid;
      gap: 10px;
    }

    .vaga-card {
      background: var(--card);
      border: 1px solid var(--line);
      border-left: 5px solid var(--brand);
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .vaga-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .badge {
      background: #eaf1fb;
      color: #194a8d;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .vaga-local {
      font-size: 0.76rem;
      color: #546070;
      text-transform: uppercase;
    }

    .vaga-title {
      font-size: 1rem;
      margin: 0;
      line-height: 1.25;
    }

    .vaga-meta {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.88rem;
    }

    .vaga-salario {
      color: var(--ok);
      font-weight: 800;
    }

    .vaga-open {
      font-weight: 700;
      color: var(--brand);
      font-size: 0.84rem;
    }

    .infos {
      display: grid;
      gap: 10px;
    }

    .info-card {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: hidden;
    }

    .info-title {
      margin: 0;
      padding: 10px 12px;
      font-size: 0.95rem;
      color: #fff;
    }

    .info-title.c1 { background: #0d6efd; }
    .info-title.c2 { background: #198754; }
    .info-title.c3 { background: #d63384; }

    .info-body {
      padding: 10px 12px;
      font-size: 0.92rem;
    }
    .cal-item {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      padding: 8px 0;
      border-bottom: 1px solid #edf2f7;
    }
    .cal-item:last-child { border-bottom: none; }
    .cal-data {
      flex: 0 0 110px;
      font-weight: 800;
      color: #2e3d4f;
    }
    .cal-evento {
      flex: 1;
      min-width: 0;
      font-weight: 700;
      color: #27303a;
      line-height: 1.35;
    }

    .empty {
      text-align: center;
      color: var(--muted);
      padding: 24px 10px;
    }

    .error {
      margin-top: 18px;
      background: #fff;
      border: 1px solid #efc7c6;
      color: #872f2c;
      border-radius: 10px;
      padding: 12px;
      font-size: 0.95rem;
    }

    .sheet {
      position: fixed;
      inset: 0;
      background: rgba(8, 16, 28, 0.48);
      display: none;
      z-index: 50;
      align-items: end;
    }

    .sheet.show { display: flex; }

    .sheet-card {
      width: 100%;
      max-height: min(84vh, calc(var(--app-height) - 16px));
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      background: #fff;
      border-radius: 16px 16px 0 0;
      padding: 14px 14px 18px;
      box-shadow: 0 -6px 30px rgba(0,0,0,0.2);
    }

    .sheet-head {
      display: flex;
      justify-content: space-between;
      align-items: start;
      gap: 10px;
    }

    .close {
      border: none;
      border-radius: 8px;
      background: #e9eff7;
      color: #263341;
      font-weight: 700;
      min-width: 40px;
      min-height: 34px;
    }

    .row { margin-top: 10px; }
    .label { color: var(--muted); font-size: 0.82rem; margin-bottom: 3px; }
    .value { font-size: 0.95rem; white-space: pre-wrap; }
  </style>
</head>
<body>
<div class="app">
  <div class="top">
    <h1 class="title">MURAL Interativo</h1>
    <div class="subtitle">Toque na vaga para ver detalhes completos.</div>
    <div class="tabs" id="tabs"></div>
    <div class="status" id="status">Validando acesso...</div>
  </div>

  <main id="content"></main>
</div>

<div class="sheet" id="sheet">
  <div class="sheet-card">
    <div class="sheet-head">
      <h2 id="sheetTitle" style="margin: 0; font-size: 1.1rem;"></h2>
      <button class="close" id="sheetClose">Fechar</button>
    </div>
    <div id="sheetBody"></div>
  </div>
</div>

<script>
  const categorias = [
    { key: "CONVENCIONAL", label: "Convencional" },
    { key: "SUPERIOR", label: "Superior" },
    { key: "PCD", label: "PCD" },
    { key: "INFO", label: "Info" }
  ];
  const coresCategoria = {
    CONVENCIONAL: "#0056b3",
    SUPERIOR: "#d35400",
    PCD: "#16a085",
    INFO: "#6f42c1"
  };

  const qrToken = new URLSearchParams(window.location.search).get("t");
  const tabsEl = document.getElementById("tabs");
  const contentEl = document.getElementById("content");
  const statusEl = document.getElementById("status");
  const sheetEl = document.getElementById("sheet");
  const sheetBodyEl = document.getElementById("sheetBody");
  const sheetTitleEl = document.getElementById("sheetTitle");
  let dataAtual = null;
  let abaAtual = "CONVENCIONAL";
  let expiraEm = 0;
  let sessionToken = null;

  function atualizarAlturaApp() {
    const altura = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    document.documentElement.style.setProperty("--app-height", `${Math.round(altura)}px`);
  }

  async function apiFetch(url) {
    return fetch(url, {
      method: "GET",
      cache: "no-store",
      credentials: "same-origin"
    });
  }

  function corDaCategoria(cat) {
    return coresCategoria[cat] || "#0a66d1";
  }

  function hexParaRgba(hex, alpha) {
    const h = (hex || "").replace("#", "");
    if (h.length !== 6) return `rgba(10, 102, 209, ${alpha})`;
    const r = parseInt(h.slice(0, 2), 16);
    const g = parseInt(h.slice(2, 4), 16);
    const b = parseInt(h.slice(4, 6), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }

  function formatarDataHora(epochSeconds) {
    if (!epochSeconds) return "-";
    return new Date(epochSeconds * 1000).toLocaleString("pt-BR");
  }

  function statusSessao() {
    if (!expiraEm) return;
    const agora = Math.floor(Date.now() / 1000);
    const restante = Math.max(0, expiraEm - agora);
    const min = Math.floor(restante / 60);
    const sec = restante % 60;
    statusEl.textContent = `Acesso ativo ate ${formatarDataHora(expiraEm)} (${min}m ${sec}s)`;
  }

  function renderTabs() {
    tabsEl.innerHTML = "";
    categorias.forEach(cat => {
      const btn = document.createElement("button");
      btn.className = "tab-btn" + (cat.key === abaAtual ? " active" : "");
      btn.textContent = cat.label;
      if (cat.key === abaAtual) {
        const cor = corDaCategoria(cat.key);
        btn.style.backgroundColor = cor;
        btn.style.borderColor = cor;
      }
      btn.addEventListener("click", () => {
        abaAtual = cat.key;
        renderTabs();
        renderConteudo();
      });
      tabsEl.appendChild(btn);
    });
  }

  function abrirDetalhes(vaga) {
    sheetTitleEl.textContent = vaga.titulo || "Vaga";
    sheetBodyEl.innerHTML = `
      <div class="row"><div class="label">Codigo</div><div class="value">${vaga.codigo || "-"}</div></div>
      <div class="row"><div class="label">Categoria</div><div class="value">${vaga.categoria || "-"}</div></div>
      <div class="row"><div class="label">Salario</div><div class="value">R$ ${vaga.salario || "-"}</div></div>
      <div class="row"><div class="label">Local</div><div class="value">${vaga.local || "-"}</div></div>
      <div class="row"><div class="label">Experiencia</div><div class="value">${vaga.experiencia || "-"}</div></div>
      <div class="row"><div class="label">Beneficios</div><div class="value">${vaga.beneficios || "-"}</div></div>
      <div class="row"><div class="label">Atribuicoes</div><div class="value">${vaga.atribuicoes || "-"}</div></div>
      <div class="row"><div class="label">Validade da vaga</div><div class="value">${vaga.validade || "-"}</div></div>
    `;
    sheetEl.classList.add("show");
  }

  function renderInfos() {
    const infos = dataAtual.infos || {};
    const cursos = Array.isArray(infos.cursos) ? infos.cursos : [];
    const processos = Array.isArray(infos.processos) ? infos.processos : [];
    const cronograma = Array.isArray(infos.cronograma) ? infos.cronograma : [];

    contentEl.innerHTML = `
      <section class="infos">
        <article class="info-card">
          <h3 class="info-title c1">Cursos e Qualificacoes</h3>
          <div class="info-body">
            ${cursos.length ? cursos.map(c => `<p><strong>${c.nome || ""}</strong><br>${c.detalhe || ""}</p>`).join("") : "<div class='empty'>Sem cursos cadastrados.</div>"}
          </div>
        </article>
        <article class="info-card">
          <h3 class="info-title c2">Processos na Agencia</h3>
          <div class="info-body">
            ${processos.length ? processos.map(p => `<p><strong>${p.empresa || ""}</strong><br>${p.data || ""}<br>${(p.texto || []).join("<br>")}</p>`).join("<hr>") : "<div class='empty'>Sem processos cadastrados.</div>"}
          </div>
        </article>
        <article class="info-card">
          <h3 class="info-title c3">Calend√°rio</h3>
          <div class="info-body">
            ${cronograma.length ? cronograma.map(c => `
              <div class="cal-item">
                <div class="cal-data">${c.data || ""}</div>
                <div class="cal-evento">${c.evento || ""}</div>
              </div>
            `).join("") : "<div class='empty'>Sem eventos cadastrados.</div>"}
          </div>
        </article>
      </section>
    `;
  }

  function renderVagas(categoria) {
    const vagas = (dataAtual.vagas || []).filter(v => (v.categoria || "").toUpperCase() === categoria);
    const corCategoria = corDaCategoria(categoria);
    const badgeBg = hexParaRgba(corCategoria, 0.16);
    const badgeInk = corCategoria;
    if (!vagas.length) {
      contentEl.innerHTML = "<div class='empty'>Nenhuma vaga nesta categoria agora.</div>";
      return;
    }

    const html = vagas.map(v => `
      <article class="vaga-card" data-id="${v.id}" style="border-left-color:${corCategoria}">
        <div class="vaga-head">
          <span class="badge" style="background:${badgeBg};color:${badgeInk}">${v.codigo || "-"}</span>
          <span class="vaga-local">${v.local || ""}</span>
        </div>
        <h3 class="vaga-title">${v.titulo || "-"}</h3>
        <div class="vaga-meta">
          <span class="vaga-salario">R$ ${v.salario || "-"}</span>
          <span class="vaga-open" style="color:${corCategoria}">Abrir detalhes</span>
        </div>
      </article>
    `).join("");

    contentEl.innerHTML = `<section class="vagas-grid">${html}</section>`;
    contentEl.querySelectorAll(".vaga-card").forEach(el => {
      const id = Number(el.getAttribute("data-id"));
      const vaga = (dataAtual.vagas || []).find(v => v.id === id);
      el.addEventListener("click", () => abrirDetalhes(vaga || {}));
    });
  }

  function renderConteudo() {
    if (!dataAtual) return;
    if (abaAtual === "INFO") {
      renderInfos();
      return;
    }
    renderVagas(abaAtual);
  }

  async function carregarDados() {
    const res = await apiFetch(`/api/mural/data?t=${encodeURIComponent(sessionToken)}`);
    if (!res.ok) throw new Error("Acesso negado");
    dataAtual = await res.json();
    expiraEm = dataAtual.expiresAtEpochSeconds || 0;
    renderTabs();
    renderConteudo();
    statusSessao();
  }

  async function iniciarSessaoComQr(token) {
    if (!token) {
      throw new Error("Token ausente no link");
    }
    const res = await apiFetch(`/api/mural/session?t=${encodeURIComponent(token)}`);
    if (!res.ok) throw new Error("QR code invalido. Escaneie novamente na TV.");
    const s = await res.json();
    if (!s.token) {
      throw new Error("Falha ao iniciar sessao do mural.");
    }
    sessionToken = s.token;
    expiraEm = s.expiresAtEpochSeconds || 0;
    const novaUrl = `${window.location.pathname}?t=${encodeURIComponent(sessionToken)}`;
    window.history.replaceState({}, "", novaUrl);
  }

  async function tentarUsarSessaoAtual(token) {
    if (!token) return false;
    const res = await apiFetch(`/api/mural/validate?t=${encodeURIComponent(token)}`);
    if (!res.ok) return false;
    const v = await res.json();
    if (v.valid) {
      sessionToken = token;
      expiraEm = v.expiresAtEpochSeconds || 0;
      return true;
    }
    if (v.wrongNetwork) throw new Error("Este acesso so funciona dentro da agencia.");
    if (v.expired) return false;
    if (v.wrongType) return false;
    return false;
  }

  function renderErro(msg) {
    contentEl.innerHTML = `<div class="error">${msg}</div>`;
    statusEl.textContent = "Acesso indisponivel.";
  }

  document.getElementById("sheetClose").addEventListener("click", () => sheetEl.classList.remove("show"));
  sheetEl.addEventListener("click", (e) => {
    if (e.target === sheetEl) sheetEl.classList.remove("show");
  });
  window.addEventListener("resize", atualizarAlturaApp);
  window.addEventListener("orientationchange", atualizarAlturaApp);
  if (window.visualViewport) {
    window.visualViewport.addEventListener("resize", atualizarAlturaApp);
  }
  window.addEventListener("pageshow", (event) => {
    if (!event.persisted) return;
    atualizarAlturaApp();
    carregarDados().catch(() => {});
  });
  atualizarAlturaApp();

  (async () => {
    try {
      const tokenAtual = new URLSearchParams(window.location.search).get("t");
      const sessaoValida = await tentarUsarSessaoAtual(tokenAtual);
      if (!sessaoValida) {
        await iniciarSessaoComQr(tokenAtual);
      }
      await carregarDados();
      setInterval(statusSessao, 1000);
      setInterval(async () => {
        try {
          await carregarDados();
        } catch (e) {
          renderErro("Sessao expirada ou fora da rede da agencia. Escaneie novamente o QR da TV.");
        }
      }, 60000);
    } catch (e) {
      renderErro(e.message || "Nao foi possivel carregar o mural.");
    }
  })();
</script>
</body>
</html>
